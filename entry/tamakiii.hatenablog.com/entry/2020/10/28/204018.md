---
Title: HomeBrew ã§ Custom Build from Source ã™ã‚‹
Date: 2020-10-28T20:40:18+09:00
URL: https://tamakiii.hatenablog.com/entry/2020/10/28/204018
EditURL: https://blog.hatena.ne.jp/tamakiii/tamakiii.hatenablog.com/atom/entry/26006613646264802
---

æœ€è¿‘ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹æ©Ÿä¼šãŒå¢—ãˆã¦ãã¦ã€ãƒ›ã‚¹ãƒˆOSä¸Šã§å¸¸ç”¨ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦ã¯å°‘ã—ç®¡ç†ã§ããŸæ–¹ãŒã‚ˆã•ãã†ã¨ã„ã†ã“ã¨ã§ã€HomeBrew ã§ Build from Source ã‚’è©¦ã—ã¦ã„ã¾ã™ã€‚
ä¾‹ãˆã° `vim` ã® `clientserver` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ãŸã„ã€ã¨ã‹ãŒ `brew install` ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼ˆã¾ã ã§ãã¦ã„ãªã„ï¼‰ã€‚

HomeBrew ã¯ç‹¬ç‰¹ã®ä¸–ç•Œè¦³ãŒã‚ã£ã¦ã‹[?] æƒ…å ±ãŒå°‘ãªã„ã‹ã‚‰ãªã®ã‹å°‘ã—æ··ä¹±ã—ã¾ã—ãŸãŒã€æ…£ã‚Œã‚Œã°ã¾ã‚ä½¿ãˆã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
æ…£ã‚Œã‚Œã°è‡ªä½œã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’é…å¸ƒã™ã‚‹æ•·å±…ãŒä¸‹ãŒã£ãŸã‚Šã€macOS ã‚’ä½¿ã£ã¦ã„ã‚‹äººã®ç’°å¢ƒå‘ä¸Šã«å¯„ä¸ã§ãã¦ã„ã„ã‚“ã˜ã‚ƒãªã„ã§ã—ã‚‡ã†ã‹ã€‚çŸ¥ã‚‰ã‚“ã‘ã©ã€‚

### Tap ã‚’ä½œã‚‹

ã¾ãšã¯ Tap ã‚’ä½œã‚Šã¾ã™ã€‚Tap ã¨ã¯ `A Git repository of Formulae and/or commands` ã‚‰ã—ã„ã§ã™ã€‚
Formula ã¯ `*.rb` ã«ãªã£ã¦ã„ã‚‹ `The package definition`ã€ã¤ã¾ã‚Š `vim` `git` `make` ã¨ã‹ã§ã™ã€‚

HomeBrew ã®ç”¨èªã¯ã“ã¡ã‚‰ï¼ˆKegã€Cellarã€Cask ãªã©ï¼‰ã€‚
[https://docs.brew.sh/Formula-Cookbook:embed:cite]

ãƒªãƒã‚¸ãƒˆãƒªã®åå‰ã‚’è€ƒãˆã¾ã™ã€‚`tamakiii/homebrew-core` ã¯æœ¬å®¶ã® `homebrew/homebrew-core` ã¨ç«¶åˆã™ã‚‹ï¼ˆæœ¬å®¶ã« Pull Request ã‚’é€ã‚ŠãŸã„ã¨ãã«å›°ã‚‹ï¼‰ã®ã§ `tamakiii/homebrew-tap` ã¨ã—ã¾ã™ã€‚
```
$ brew tap-new tamakiii/homebrew-tap
Initialized empty Git repository in /usr/local/Homebrew/Library/Taps/tamakiii/homebrew-tap/.git/
[master (root-commit) 390ec63] Create tamakiii/tap tap
 3 files changed, 85 insertions(+)
 create mode 100644 .github/workflows/publish.yml
 create mode 100644 .github/workflows/tests.yml
 create mode 100644 README.md
==> Created tamakiii/tap
/usr/local/Homebrew/Library/Taps/tamakiii/homebrew-tap

When a pull request making changes to a formula (or formulae) becomes green
(all checks passed), then you can publish the built bottles.
To do so, label your PR as `pr-pull` and the workflow will be triggered.
```

ä½œã£ãŸ Tap ãŒã“ã¡ã‚‰ã€‚README ã¨ `Formula/` `.github/workflows` ãŒã‚ã‚‹ã ã‘ã®ç°¡å˜ãªæ§‹æˆã§ã™ã€‚
åå‰ã® `homebrew-` éƒ¨åˆ†ã¯çœç•¥ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚
```
$ ls -lsa /usr/local/Homebrew/Library/Taps/tamakiii/homebrew-tap
total 8
0 drwxrwxr-x   6 tamakiii  admin  192 10 28 19:23 .
0 drwxrwxr-x   4 tamakiii  admin  128 10 28 19:23 ..
0 drwxrwxr-x  12 tamakiii  admin  384 10 28 19:28 .git
0 drwxrwxr-x   3 tamakiii  admin   96 10 28 19:23 .github
0 drwxrwxr-x   3 tamakiii  admin   96 10 28 19:27 Formula
8 -rw-rw-r--   1 tamakiii  admin  254 10 28 19:23 README.md

$ brew --repo tamakiii/tap
/usr/local/Homebrew/Library/Taps/tamakiii/homebrew-tap

$ brew --repo tamakiii/homebrew-tap
/usr/local/Homebrew/Library/Taps/tamakiii/homebrew-tap
```

## ãƒ“ãƒ«ãƒ‰ã—ã¦ã¿ã‚‹

è©¦ã—ã«æœ¬å®¶ã® `vim.rb` ã‚’å…¥ã‚Œã¦ã¿ã¾ã™ã€‚
```
$ cp /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core/Formula/vim.rb Formula/
```

ã‚³ãƒ”ãƒ¼ã—ãŸä¸­èº«ã¯ã“ã¡ã‚‰ã€‚ä¾å­˜é–¢ä¿‚ã‚„ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰æœ¬ä½“ã€ãƒ†ã‚¹ãƒˆãªã©ãŒã‚ã‚Šã€å˜ä½“ã® Ruby ãƒ•ã‚¡ã‚¤ãƒ«ã§å®Œçµã—ã¦å‹•ãã¾ã™ã€‚
[https://github.com/Homebrew/homebrew-core/blob/23d26ef9baf5b9755b73d73bfe63264501dbd179/Formula/vim.rb:embed:cite]

è¿½åŠ ã—ãŸ `vim` Formula ã¯ã€`<tap-name>/<formula-name>` ã§æŒ‡å®šã§ãã¾ã™ã€‚
```
$ brew info tamakiii/tap/vim
tamakiii/tap/vim: stable 8.2.1900 (bottled), HEAD
Vi 'workalike' with many additional features
https://www.vim.org/
Conflicts with:
  ex-vi (because vim and ex-vi both install bin/ex and bin/view)
  macvim (because vim and macvim both install vi* binaries)
/usr/local/Cellar/vim/8.2.1900 (1,953 files, 33.3MB) *
  Built from source on 2020-10-28 at 19:29:45
From: https://github.com/tamakiii/homebrew-tap/blob/HEAD/Formula/vim.rb
License: Vim
==> Dependencies
Required: gettext âœ”, lua âœ”, perl âœ”, python@3.9 âœ”, ruby âœ”
==> Options
--HEAD
        Install HEAD version
==> Analytics
install: 83,045 (30 days), 238,945 (90 days), 873,774 (365 days)
install-on-request: 80,611 (30 days), 231,601 (90 days), 835,450 (365 days)
build-error: 0 (30 days)
```

ãƒ“ãƒ«ãƒ‰å‡ºæ¥ã¾ã—ãŸã€‚Bottle ãŒè½ã¨ã›ãªãã¦æ€’ã‚‰ã‚Œã¦ã„ã¾ã™ãŒä»Šå›ã¯æ°—ã«ã—ãªãã¦ã‚ˆã•ãã†ã§ã™ã€‚
```
$ brew install tamakiii/tap/vim
Updating Homebrew...
Warning: tamakiii/tap/vim 8.2.1900 is already installed and up-to-date
To reinstall 8.2.1900, run `brew reinstall vim`

$ brew reinstall tamakiii/tap/vim
==> Downloading https://homebrew.bintray.com/bottles-tap/vim-8.2.1900.catalina.bottle.tar.gz
##O=#  #
curl: (22) The requested URL returned error: 404 Not Found
Error: Failed to download resource "vim"
Download failed: https://homebrew.bintray.com/bottles-tap/vim-8.2.1900.catalina.bottle.tar.gz
Warning: Bottle installation failed: building from source.
==> Downloading https://github.com/vim/vim/archive/v8.2.1900.tar.gz
Already downloaded: /Users/tamakiii/Library/Caches/Homebrew/downloads/094d05292a53960f72fae76726aee6cb028b92fbdabc0eb56191a4308b5f8821--vim-8.2.1900.tar.gz
==> Reinstalling tamakiii/tap/vim
Warning: A newer Command Line Tools release is available.
Update them from Software Update in System Preferences or run:
  softwareupdate --all --install --force

If that doesn't show you an update run:
  sudo rm -rf /Library/Developer/CommandLineTools
  sudo xcode-select --install

Alternatively, manually download them from:
  https://developer.apple.com/download/more/.

==> ./configure --prefix=/usr/local --mandir=/usr/local/Cellar/vim/8.2.1900/share/man --enable-multibyte --with-tlib=ncurses --with-compiledby=Homebrew --enable-csco
==> make
==> make install prefix=/usr/local/Cellar/vim/8.2.1900 STRIP=/usr/bin/true
ğŸº  /usr/local/Cellar/vim/8.2.1900: 1,953 files, 33.3MB, built in 1 minute 27 seconds
```

`vim` Formula ã«ã¯ Bottle ãŒãªã„ã®ã§ã“ã‚Œã§è‰¯ã„ã§ã™ãŒã€è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã«ã¯ `--build-from-source` ã‚’ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ã§ã™ã€‚ã›ã„ãœã„æ•°å°ã®ãƒã‚·ãƒ³ã§å‹•ã‹ã™ã‚‚ã®ãªã®ã§ Bottle ã®è¨˜è¿°ã¯å‰Šã‚‹ã¨ã‚ˆã•ãã†ã§ã™ã€‚

ã¾ãŸã€`./configure` ã‚„ `make` ã®å‡ºåŠ›ãŒã»ã—ã„ã¨ã“ã‚ãªã®ã§ `--verbose` ã‚’ã¤ã‘ã‚‹ã¨ã‚ˆã•ãã†ã§ã™ã€‚ `--debug` ã¯ã¡ã‚‡ã£ã¨ã†ã‚‹ã•ã‹ã£ãŸã®ã§ã‚„ã‚ã¾ã—ãŸã€‚
```
$ brew reinstall --force --verbose --build-from-source tamakiii/tap/vim
rm /usr/local/bin/ex
rm /usr/local/bin/rview
rm /usr/local/bin/rvim
rm /usr/local/bin/vi
rm /usr/local/bin/view
rm /usr/local/bin/vim

...

/usr/bin/sandbox-exec -f /private/tmp/homebrew20201028-85925-14282ki.sb nice ruby -W0 -I $LOAD_PATH -- /usr/local/Homebrew/Library/Homebrew/build.rb /usr/local/Homebrew/Library/Taps/tamakiii/homebrew-tap/Formula/vim.rb --verbose
tar xof /Users/tamakiii/Library/Caches/Homebrew/downloads/094d05292a53960f72fae76726aee6cb028b92fbdabc0eb56191a4308b5f8821--vim-8.2.1900.tar.gz -C /private/tmp/d20201028-85926-10g8sdh
cp -pR /private/tmp/d20201028-85926-10g8sdh/vim-8.2.1900/. /private/tmp/vim-20201028-85926-1g5a3uf/vim-8.2.1900
chmod -Rf +w /private/tmp/d20201028-85926-10g8sdh
==> ./configure --prefix=/usr/local --mandir=/usr/local/Cellar/vim/8.2.1900/share/man --enable-multibyte --with-tlib=ncurses --with-compiledby=Homebrew --enable-cscope --enable-terminal --enable-perlinterp --enable-rubyinterp --enable-python3interp --enable-gui=no --without-x --enable-luainterp --with-lua-prefix=/usr/local/opt/lua --enable-fail-if-missing
configure: creating cache auto/config.cache
checking whether make sets $(MAKE)... yes
checking for gcc... clang
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out

...

/usr/bin/sandbox-exec -f /private/tmp/homebrew20201028-92467-f57b26.sb nice ruby -W0 -I $LOAD_PATH -- /usr/local/Homebrew/Library/Homebrew/postinstall.rb /usr/local/Homebrew/Library/Taps/tamakiii/homebrew-tap/Formula/vim.rb
==> Summary
ğŸº  /usr/local/Cellar/vim/8.2.1900: 1,953 files, 33.3MB, built in 1 minute 45 seconds
```


## homebrew/homebrew-core ã®å ´åˆ

[`homebrew/homebrew-core`](https://github.com/Homebrew/homebrew-core) è‡ªä½“ã‚‚ HomeBrew çš„ã«ã¯ Tap ã®æ‰±ã„ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
```
$ tree -L 2 /usr/local/Homebrew/Library/Taps
/usr/local/Homebrew/Library/Taps
â”œâ”€â”€ homebrew
â”‚Â Â  â”œâ”€â”€ homebrew-brewdler
â”‚Â Â  â”œâ”€â”€ homebrew-bundle
â”‚Â Â  â”œâ”€â”€ homebrew-cask
â”‚Â Â  â”œâ”€â”€ homebrew-cask-versions
â”‚Â Â  â”œâ”€â”€ homebrew-core
â”‚Â Â  â””â”€â”€ homebrew-services
â”œâ”€â”€ osx-cross
â”‚Â Â  â”œâ”€â”€ homebrew-arm
â”‚Â Â  â””â”€â”€ homebrew-avr
â”œâ”€â”€ qmk
â”‚Â Â  â””â”€â”€ homebrew-qmk
â””â”€â”€ tamakiii
    â”œâ”€â”€ homebrew-core
    â””â”€â”€ homebrew-tap

15 directories, 0 files
```

`homebrew/homebrew-core` ã«ã‚³ãƒŸãƒƒãƒˆã—ãŸã„å ´åˆã‚‚ã€GitHub ä¸Šã§ãƒªãƒã‚¸ãƒˆãƒªã‚’ Fork ã—ã¦ tap ã™ã‚Œã°ã€è‡ªåˆ†ç”¨ã® Tap ã¨åŒæ§˜ã«ã€å¤‰æ›´ãƒ»ãƒ“ãƒ«ãƒ‰ãƒ»Pull Request ã®ä½œæˆãŒã§ããã†ã§ã™ã€‚
```
$ brew tap tamakiii/homebrew-core
Updating Homebrew...
==> Auto-updated Homebrew!
Updated 1 tap (homebrew/cask).
==> Updated Casks
logos                            rotki                            springtoolsuite                  switchhosts                      wechatwebdevtools

$ brew --repo tamakiii/homebrew-core
/usr/local/Homebrew/Library/Taps/tamakiii/homebrew-core

$ ls -lsa /usr/local/Homebrew/Library/Taps/tamakiii/homebrew-core
total 48
0 drwxrwxr-x    13 tamakiii  admin     416 10 28 16:03 .
0 drwxrwxr-x     4 tamakiii  admin     128 10 28 19:23 ..
0 drwxrwxr-x    14 tamakiii  admin     448 10 28 16:56 .git
0 drwxrwxr-x     8 tamakiii  admin     256 10 28 16:03 .github
0 drwxrwxr-x   238 tamakiii  admin    7616 10 28 16:03 Aliases
8 -rw-rw-r--     1 tamakiii  admin     884 10 28 16:03 CODEOWNERS
8 -rw-rw-r--     1 tamakiii  admin    2960 10 28 16:03 CONTRIBUTING.md
0 drwxrwxr-x  5313 tamakiii  admin  170016 10 28 18:19 Formula
8 -rw-rw-r--     1 tamakiii  admin    1334 10 28 16:03 LICENSE.txt
8 -rw-rw-r--     1 tamakiii  admin     706 10 28 16:03 README.md
0 drwxrwxr-x     4 tamakiii  admin     128 10 28 16:03 cmd
8 -rw-rw-r--     1 tamakiii  admin    3567 10 28 16:03 formula_renames.json
8 -rw-rw-r--     1 tamakiii  admin    1144 10 28 16:03 tap_migrations.json
```

è‡ªä½œã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’é…å¸ƒã—ãŸã„å ´åˆã«ã¯ Formula ã‚’ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã«ä½œã‚‹æ©Ÿèƒ½ã‚‚ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
[https://gabecc.me/2018/05/22/writing_a_homebrew_formula.html:embed:cite]


ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ­ãƒƒã‚¯ã®ä»•çµ„ã¿ãŒã‚¤ãƒã‚¤ãƒä½¿ã„ã«ãã‹ã£ãŸã‚Šã§å°‘ã—æ€ã†æ‰€ã‚‚ã‚ã‚‹ HomeBrew ã§ã™ãŒã€ä»Šæ—¥ã‚‚å¤šãã®äººã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã¯ã‚ã‚‹ã¯ãšã§ã™ã€‚
æ˜”ã»ã© Formula ãŒå£Šã‚Œã‚‹ã“ã¨ã‚‚ã»ã¼ãªããªã£ãŸæ°—ãŒã—ã¾ã™ã—ã€ç›¸å½“ãªã‚²ãƒ¼ãƒ ãƒã‚§ãƒ³ã‚¸ãƒ£ãƒ¼ãŒè¡¨ã‚Œãªã„é™ã‚Šã¯å½“é¢ç¾å½¹ãªã‚“ã˜ã‚ƒãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
